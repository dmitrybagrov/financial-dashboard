<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard - Savings & Mortgages</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-primary: #208080;
            --color-primary-hover: #1a6b6b;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #666;
            --color-border: #ddd;
            --color-success: #218055;
            --color-warning: #a84d2f;
            --color-error: #c0152f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--color-bg);
            border-radius: 6px;
            font-size: 13px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .sync-status {
            font-size: 12px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
        }

        .sync-indicator.syncing {
            background: var(--color-warning);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--color-surface);
            padding: 10px;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--color-primary);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-primary);
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--color-text-secondary);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--color-bg);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--color-primary);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        th {
            background: var(--color-primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        tr:hover {
            background: #f9f9f9;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            background: var(--color-bg);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--color-primary);
        }

        .summary-card.success {
            border-left-color: var(--color-success);
        }

        .summary-card.warning {
            border-left-color: var(--color-warning);
        }

        .card-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text);
        }

        .currency {
            color: var(--color-primary);
        }

        .positive {
            color: var(--color-success);
        }

        .negative {
            color: var(--color-error);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-bg);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            background: #a01025;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .account-card {
            background: var(--color-bg);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .account-name {
            font-weight: 600;
            font-size: 15px;
        }

        .account-institution {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .account-balance {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
            margin: 10px 0;
        }

        .account-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .auth-modal {
            background: var(--color-surface);
            padding: 40px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .auth-modal h2 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        .auth-modal p {
            color: var(--color-text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--color-text-secondary);
            font-size: 13px;
            position: relative;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--color-border);
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .auth-toggle a {
            color: var(--color-primary);
            cursor: pointer;
            text-decoration: none;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            border: 1px solid var(--color-error);
            color: var(--color-error);
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 6px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-header {
            height: 60px;
            margin-bottom: 20px;
        }

        .skeleton-card {
            height: 120px;
            margin-bottom: 20px;
        }

        .skeleton-row {
            height: 40px;
            margin-bottom: 10px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: var(--color-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-primary));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .clickable-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .clickable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .currency-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--color-bg);
            border-radius: 6px;
            font-size: 13px;
        }

        .currency-selector select {
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
            cursor: pointer;
            padding: 4px;
        }

        .currency-selector select:focus {
            outline: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-section {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .date-range-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-range-selector select {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--color-bg);
        }

        .metric-highlight {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        .scenario-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .scenario-modal {
            background: var(--color-surface);
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .scenario-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .scenario-results {
            background: var(--color-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .comparison-table {
            width: 100%;
            margin-top: 15px;
        }

        .comparison-table th {
            background: var(--color-primary);
            color: white;
            padding: 10px;
            text-align: left;
        }

        .comparison-table td {
            padding: 10px;
            border-bottom: 1px solid var(--color-border);
        }

        .history-panel {
            background: var(--color-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--color-surface);
            padding: 12px;
            border-left: 4px solid var(--color-primary);
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .history-timestamp {
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .undo-redo-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            padding: 8px 12px;
            border: none;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .icon-btn:hover:not(:disabled) {
            background: var(--color-bg);
            transform: translateY(-1px);
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .note-badge {
            background: var(--color-warning);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        .modal-body {
            padding: 20px;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .scenario-column h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--color-text-secondary);
        }

        .scenario-result {
            background: var(--color-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .scenario-result h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .undo-redo-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: var(--color-bg);
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .undo-redo-bar button {
            padding: 6px 12px;
            font-size: 13px;
        }

        .undo-redo-bar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-panel {
            background: var(--color-bg);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--color-surface);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid var(--color-primary);
        }

        .history-timestamp {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .history-change {
            font-size: 13px;
            margin: 4px 0;
        }

        .history-note {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-style: italic;
            margin-top: 6px;
        }

        .note-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .scenario-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Financial Dashboard</h2>
            <p>Sign in to access your financial data across all devices</p>
            
            <div id="errorMessage" class="error-message hidden"></div>
            
            <button onclick="signInWithGoogle()" class="btn btn-primary" style="width: 100%;">
                <span>Continue with Google</span>
            </button>
            
            <div class="auth-divider">or</div>
            
            <div id="emailSignInForm" class="auth-form">
                <input type="email" id="emailInput" placeholder="Email" />
                <input type="password" id="passwordInput" placeholder="Password" />
                <button onclick="emailSignIn()" class="btn btn-primary">Sign In</button>
            </div>
            
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a id="authToggleLink" onclick="toggleAuthMode()">Sign up</a>
            </div>
        </div>
    </div>

    <div id="appContainer" class="container hidden">
        <div id="loadingOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-bg); z-index: 999; padding: 20px;">
            <div class="loading-skeleton skeleton-header"></div>
            <div class="loading-skeleton skeleton-card"></div>
            <div class="loading-skeleton skeleton-card"></div>
            <div class="loading-skeleton skeleton-row"></div>
            <div class="loading-skeleton skeleton-row"></div>
            <div class="loading-skeleton skeleton-row"></div>
        </div>
        
        <header>
            <div class="header-left">
                <h1>Financial Dashboard</h1>
                <p class="subtitle">Track your savings and mortgages</p>
            </div>
            <div class="header-right">
                <div class="undo-redo-bar">
                    <button id="undoBtn" class="btn btn-secondary" onclick="window.undo()" disabled title="Undo">‚Ü∂ Undo</button>
                    <button id="redoBtn" class="btn btn-secondary" onclick="window.redo()" disabled title="Redo">‚Ü∑ Redo</button>
                    <button class="btn btn-secondary" onclick="window.openHistoryModal()" title="View History">üìú History</button>
                    <button class="btn btn-primary" onclick="window.openScenarioModal()" title="What-If Planning">üí° Scenarios</button>
                </div>
                <div class="currency-selector">
                    <span>Currency:</span>
                    <select id="currencySelector" onchange="window.changeCurrency(this.value)">
                        <option value="¬£">¬£ GBP</option>
                        <option value="$">$ USD</option>
                        <option value="‚Ç¨">‚Ç¨ EUR</option>
                        <option value="¬•">¬• JPY</option>
                    </select>
                </div>
                <div class="sync-status">
                    <div id="syncIndicator" class="sync-indicator"></div>
                    <span id="syncText">Synced</span>
                </div>
                <div class="sync-status" style="border-left: 1px solid var(--color-border); padding-left: 15px;">
                    <span id="lastSavedText" style="font-size: 12px; color: var(--color-text-secondary);">Never saved</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span id="userName"></span>
                </div>
                <button onclick="signOut()" class="btn btn-secondary">Sign Out</button>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="switchTab('savings')">üí∞ Savings</button>
            <button class="tab-btn" onclick="switchTab('mortgages')">üè† Mortgages</button>
        </div>

        <div id="dashboardTab" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Financial Overview</h2>
                <div class="summary-grid">
                    <div class="summary-card success clickable-card" onclick="window.switchTab('savings')">
                        <div class="card-label">Total Savings</div>
                        <div class="card-value currency" id="totalSavingsValue">¬£0.00</div>
                    </div>
                    <div class="summary-card warning clickable-card" onclick="window.switchTab('mortgages')">
                        <div class="card-label">Total Debt</div>
                        <div class="card-value currency" id="totalDebt">¬£0.00</div>
                    </div>
                    <div class="summary-card clickable-card" onclick="window.switchTab('mortgages')">
                        <div class="card-label">Monthly Payments</div>
                        <div class="card-value currency" id="totalPayments">¬£0.00</div>
                    </div>
                    <div class="summary-card clickable-card" id="netWorth">
                        <div class="card-label">Net Worth</div>
                        <div class="card-value" id="netWorthValue">¬£0.00</div>
                    </div>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="window.exportToCSV()">üìä Export to CSV</button>
                    <button class="btn btn-primary" onclick="window.exportToPDF()">üìÑ Export to PDF</button>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Financial Insights</h2>
                <div class="chart-row">
                    <div class="chart-section">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Asset Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="assetPieChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-section">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">Debt-Free Timeline</h3>
                        <div style="padding: 20px;">
                            <div class="card-label">Time to Clear All Debt</div>
                            <div class="metric-highlight" id="debtFreeYears">-</div>
                            <p style="font-size: 13px; color: var(--color-text-secondary); margin-top: 10px;" id="debtFreeDetail">Based on current savings rate and interest payments</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Net Worth Trend</h2>
                <div class="date-range-selector">
                    <label>Show:</label>
                    <select id="chartRange" onchange="window.updateChartRange()">
                        <option value="4">Last 4 weeks</option>
                        <option value="12" selected>Last 12 weeks</option>
                        <option value="26">Last 26 weeks</option>
                        <option value="52">Last year</option>
                    </select>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="netWorthChart"></canvas>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Upcoming Reminders</h2>
                <div id="remindersList"></div>
            </div>

            <div class="section">
                <h2 class="section-title">Savings Accounts Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Account Name</th>
                            <th>Balance</th>
                            <th>Interest Rate</th>
                            <th>Monthly Interest</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="savingsSummaryTable"></tbody>
                </table>
            </div>

            <div class="section">
                <h2 class="section-title">Mortgages Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Balance</th>
                            <th>Interest Rate</th>
                            <th>Monthly Payment</th>
                            <th>Maturity Date</th>
                        </tr>
                    </thead>
                    <tbody id="mortgageSummaryTable"></tbody>
                </table>
            </div>

            <div class="section">
                <p id="lastUpdated" style="color: var(--color-text-secondary); font-size: 13px;"></p>
            </div>
        </div>

        <div id="savingsTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">Savings Accounts</h2>
                <div id="savingsAccountsList"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addSavingsAccount()">Add Account</button>
                    <button class="btn btn-secondary" onclick="resetSavings()">Reset to Defaults</button>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Savings Summary</h2>
                <div class="summary-grid">
                    <div class="summary-card success">
                        <div class="card-label">Total Balance</div>
                        <div class="card-value currency" id="totalSavings">¬£0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Monthly Interest</div>
                        <div class="card-value currency" id="monthlyInterest">¬£0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Annual Interest</div>
                        <div class="card-value currency" id="annualInterest">¬£0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="mortgagesTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">Residential Mortgage (Repayment)</h2>
                <div class="form-group">
                    <div>
                        <label>Lender</label>
                        <input type="text" id="residentialLender" value="Your Bank Name">
                    </div>
                    <div>
                        <label>Original Amount (¬£)</label>
                        <input type="number" id="residentialOriginal" value="450000">
                    </div>
                    <div>
                        <label>Current Balance (¬£)</label>
                        <input type="number" id="residentialBalance" value="250000">
                    </div>
                    <div>
                        <label>Interest Rate (%)</label>
                        <input type="number" step="0.01" id="residentialRate" value="4.75">
                    </div>
                    <div>
                        <label>Term Remaining (years)</label>
                        <input type="number" id="residentialTerm" value="25">
                    </div>
                    <div>
                        <label>Maturity Date</label>
                        <input type="date" id="residentialMaturity" value="2050-12-31">
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="card-label">Monthly Payment</div>
                        <div class="card-value currency" id="monthlyPayment">¬£0.00</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="card-label">Annual Interest</div>
                        <div class="card-value currency" id="annualResInterest">¬£0.00</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Buy-to-Let 1 (Interest Only)</h2>
                <div class="form-group">
                    <div>
                        <label>Lender</label>
                        <input type="text" id="btl1Lender" value="Your Bank Name">
                    </div>
                    <div>
                        <label>Original Amount (¬£)</label>
                        <input type="number" id="btl1Original" value="200000">
                    </div>
                    <div>
                        <label>Current Balance (¬£)</label>
                        <input type="number" id="btl1Balance" value="180000">
                    </div>
                    <div>
                        <label>Interest Rate (%)</label>
                        <input type="number" step="0.01" id="btl1Rate" value="5.25">
                    </div>
                    <div>
                        <label>Maturity Date</label>
                        <input type="date" id="btl1Maturity" value="2035-09-30">
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="card-label">Monthly Payment</div>
                        <div class="card-value currency" id="btl1MonthlyPayment">¬£0.00</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="card-label">Annual Interest</div>
                        <div class="card-value currency" id="btl1AnnualInterest">¬£0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Capital to Repay</div>
                        <div class="card-value currency" id="btl1Capital">¬£0.00</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="btl1Progress" style="width: 0%"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--color-text-secondary); margin-top: 4px;" id="btl1ProgressText">0% paid off</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Years Until Maturity</div>
                        <div class="card-value" id="btl1Years">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Annual Savings Needed</div>
                        <div class="card-value currency" id="btl1AnnualPlan">¬£0.00</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Buy-to-Let 2 (Interest Only)</h2>
                <div class="form-group">
                    <div>
                        <label>Lender</label>
                        <input type="text" id="btl2Lender" value="Your Bank Name">
                    </div>
                    <div>
                        <label>Original Amount (¬£)</label>
                        <input type="number" id="btl2Original" value="150000">
                    </div>
                    <div>
                        <label>Current Balance (¬£)</label>
                        <input type="number" id="btl2Balance" value="150000">
                    </div>
                    <div>
                        <label>Interest Rate (%)</label>
                        <input type="number" step="0.01" id="btl2Rate" value="5.10">
                    </div>
                    <div>
                        <label>Maturity Date</label>
                        <input type="date" id="btl2Maturity" value="2038-03-31">
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="card-label">Monthly Payment</div>
                        <div class="card-value currency" id="btl2MonthlyPayment">¬£0.00</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="card-label">Annual Interest</div>
                        <div class="card-value currency" id="btl2AnnualInterest">¬£0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Capital to Repay</div>
                        <div class="card-value currency" id="btl2Capital">¬£0.00</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="btl2Progress" style="width: 0%"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--color-text-secondary); margin-top: 4px;" id="btl2ProgressText">0% paid off</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Years Until Maturity</div>
                        <div class="card-value" id="btl2Years">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Annual Savings Needed</div>
                        <div class="card-value currency" id="btl2AnnualPlan">¬£0.00</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Total Mortgage Obligations</h2>
                <div class="summary-grid">
                    <div class="summary-card warning">
                        <div class="card-label">Total Monthly Payment</div>
                        <div class="card-value currency" id="totalMortgagePayment">¬£0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-label">Total Outstanding</div>
                        <div class="card-value currency" id="netLiabilities">¬£0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scenarioModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>üí° What-If Scenario Planning</h2>
                <button class="modal-close" onclick="window.closeScenarioModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;">Compare your current situation with a hypothetical scenario. Changes here won't affect your actual data.</p>
                
                <div class="scenario-grid">
                    <div class="scenario-column">
                        <h3>üìä Current Situation</h3>
                        <div class="summary-card">
                            <div class="card-label">Total Savings</div>
                            <div class="card-value currency" id="currentSavings">¬£0.00</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Total Debt</div>
                            <div class="card-value currency" id="currentDebt">¬£0.00</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-label">Net Worth</div>
                            <div class="card-value" id="currentNetWorth">¬£0.00</div>
                        </div>
                    </div>
                    
                    <div class="scenario-column">
                        <h3>üîÆ What-If Scenario</h3>
                        <div class="form-group">
                            <div>
                                <label>Savings Change (%)</label>
                                <input type="number" id="scenarioSavingsChange" value="0" step="1">
                            </div>
                            <div>
                                <label>Debt Change (%)</label>
                                <input type="number" id="scenarioDebtChange" value="0" step="1">
                            </div>
                            <div>
                                <label>Interest Rate Change (%)</label>
                                <input type="number" id="scenarioRateChange" value="0" step="0.1">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="window.calculateScenario()" style="width: 100%; margin-top: 10px;">Calculate Scenario</button>
                    </div>
                </div>
                
                <div id="scenarioResults" class="scenario-result" style="display: none;">
                    <h3>üìà Scenario Results</h3>
                    <div class="comparison-row">
                        <span>New Savings:</span>
                        <strong class="currency" id="scenarioNewSavings">¬£0.00</strong>
                    </div>
                    <div class="comparison-row">
                        <span>New Debt:</span>
                        <strong class="currency" id="scenarioNewDebt">¬£0.00</strong>
                    </div>
                    <div class="comparison-row">
                        <span>New Net Worth:</span>
                        <strong id="scenarioNewNetWorth">¬£0.00</strong>
                    </div>
                    <div class="comparison-row">
                        <span>Change in Net Worth:</span>
                        <strong id="scenarioNetWorthChange">¬£0.00</strong>
                    </div>
                    <div class="comparison-row">
                        <span>Monthly Interest (New):</span>
                        <strong class="currency" id="scenarioMonthlyInterest">¬£0.00</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>üìú Account History</h2>
                <button class="modal-close" onclick="window.closeHistoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="history-panel" id="historyContent">
                    <p style="color: var(--color-text-secondary);">No history available yet. Changes will appear here as you modify your data.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="scenarioOverlay" class="scenario-overlay">
        <div class="scenario-modal">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üîÆ What-If Scenario Planner</h2>
                <button onclick="window.closeScenarioPlanner()" style="border: none; background: transparent; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">√ó</button>
            </div>
            
            <p style="color: var(--color-text-secondary); margin-bottom: 20px;">Adjust values below to see how changes would affect your financial position.</p>
            
            <div class="scenario-form">
                <div>
                    <label>Total Savings Change (%)</label>
                    <input type="number" id="scenarioSavingsChange" value="0" step="5" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px;">
                </div>
                <div>
                    <label>Residential Balance Change (%)</label>
                    <input type="number" id="scenarioResChange" value="0" step="5" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px;">
                </div>
                <div>
                    <label>BTL1 Balance Change (%)</label>
                    <input type="number" id="scenarioBtl1Change" value="0" step="5" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px;">
                </div>
                <div>
                    <label>BTL2 Balance Change (%)</label>
                    <input type="number" id="scenarioBtl2Change" value="0" step="5" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px;">
                </div>
                <div>
                    <label>Interest Rate Change (%)</label>
                    <input type="number" id="scenarioRateChange" value="0" step="0.25" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px;">
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="window.calculateScenario()">Calculate Scenario</button>
                <button class="btn btn-secondary" onclick="window.resetScenario()">Reset</button>
            </div>
            
            <div class="scenario-results" id="scenarioResults" style="display: none;">
                <h3 style="margin-bottom: 15px;">Comparison</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Current</th>
                            <th>Scenario</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody id="scenarioTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyCxUS2oEI5Un3eapWgX5pf81KmncvQilqk",
          authDomain: "finboard-e6010.firebaseapp.com",
          projectId: "finboard-e6010",
          storageBucket: "finboard-e6010.firebasestorage.app",
          messagingSenderId: "706897102902",
          appId: "1:706897102902:web:5cec50c0743e197c1eb097"
        };

        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('errorMessage').textContent = 
                'Firebase configuration error. Please check your Firebase config in the HTML file.';
            document.getElementById('errorMessage').classList.remove('hidden');
            throw error;
        }
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isSignUp = false;
        let isLoadingFromSnapshot = false;
        let currentCurrency = '¬£';
        let assetPieChart = null;
        let netWorthChart = null;
        let historicalData = [];
        let undoStack = [];
        let redoStack = [];
        let changeHistory = [];
        let isUndoRedoAction = false;
        let savingsAccounts = [
            { name: 'Premium Savings Account', institution: 'Your Bank Name', balance: 45000, rate: 5.15, notes: 'ISA - Tax Free' },
            { name: 'Standard Savings', institution: 'Your Bank Name', balance: 12500, rate: 3.50, notes: 'Regular Saver' },
            { name: 'Money Market Fund', institution: 'Your Bank Name', balance: 8750, rate: 4.25, notes: 'Short-term parking' }
        ];
        
        window.savingsAccounts = savingsAccounts;

        window.changeCurrency = function(symbol) {
            currentCurrency = symbol;
            document.querySelectorAll('.currency').forEach(el => {
                const value = el.textContent.replace(/[¬£$‚Ç¨¬•,]/g, '');
                el.textContent = symbol + value;
            });
            saveData();
        };

        function updateLastSaved() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastSavedText').textContent = `Last saved: ${timeStr}`;
        }

        function captureState() {
            return {
                savingsAccounts: JSON.parse(JSON.stringify(window.savingsAccounts)),
                residentialLender: document.getElementById('residentialLender').value,
                residentialOriginal: document.getElementById('residentialOriginal').value,
                residentialBalance: document.getElementById('residentialBalance').value,
                residentialRate: document.getElementById('residentialRate').value,
                residentialTerm: document.getElementById('residentialTerm').value,
                residentialMaturity: document.getElementById('residentialMaturity').value,
                btl1Lender: document.getElementById('btl1Lender').value,
                btl1Original: document.getElementById('btl1Original').value,
                btl1Balance: document.getElementById('btl1Balance').value,
                btl1Rate: document.getElementById('btl1Rate').value,
                btl1Maturity: document.getElementById('btl1Maturity').value,
                btl2Lender: document.getElementById('btl2Lender').value,
                btl2Original: document.getElementById('btl2Original').value,
                btl2Balance: document.getElementById('btl2Balance').value,
                btl2Rate: document.getElementById('btl2Rate').value,
                btl2Maturity: document.getElementById('btl2Maturity').value
            };
        }

        function restoreState(state) {
            isUndoRedoAction = true;
            
            window.savingsAccounts = JSON.parse(JSON.stringify(state.savingsAccounts));
            document.getElementById('residentialLender').value = state.residentialLender;
            document.getElementById('residentialOriginal').value = state.residentialOriginal;
            document.getElementById('residentialBalance').value = state.residentialBalance;
            document.getElementById('residentialRate').value = state.residentialRate;
            document.getElementById('residentialTerm').value = state.residentialTerm;
            document.getElementById('residentialMaturity').value = state.residentialMaturity;
            document.getElementById('btl1Lender').value = state.btl1Lender;
            document.getElementById('btl1Original').value = state.btl1Original;
            document.getElementById('btl1Balance').value = state.btl1Balance;
            document.getElementById('btl1Rate').value = state.btl1Rate;
            document.getElementById('btl1Maturity').value = state.btl1Maturity;
            document.getElementById('btl2Lender').value = state.btl2Lender;
            document.getElementById('btl2Original').value = state.btl2Original;
            document.getElementById('btl2Balance').value = state.btl2Balance;
            document.getElementById('btl2Rate').value = state.btl2Rate;
            document.getElementById('btl2Maturity').value = state.btl2Maturity;
            
            renderSavingsAccounts();
            recalculate();
            
            isUndoRedoAction = false;
        }

        function pushToUndoStack() {
            if (isUndoRedoAction) return;
            
            const state = captureState();
            undoStack.push(state);
            
            // Keep only last 50 states
            if (undoStack.length > 50) {
                undoStack.shift();
            }
            
            // Clear redo stack when new action is made
            redoStack = [];
            
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = undoStack.length === 0;
            document.getElementById('redoBtn').disabled = redoStack.length === 0;
        }

        window.undo = function() {
            if (undoStack.length === 0) return;
            
            const currentState = captureState();
            redoStack.push(currentState);
            
            const previousState = undoStack.pop();
            restoreState(previousState);
            
            updateUndoRedoButtons();
            
            addToHistory('Undo action', 'Reverted to previous state');
        };

        window.redo = function() {
            if (redoStack.length === 0) return;
            
            const currentState = captureState();
            undoStack.push(currentState);
            
            const nextState = redoStack.pop();
            restoreState(nextState);
            
            updateUndoRedoButtons();
            
            addToHistory('Redo action', 'Restored next state');
        };

        function addToHistory(action, details, note = '') {
            changeHistory.push({
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                note: note
            });
            
            // Keep only last 100 history items
            if (changeHistory.length > 100) {
                changeHistory.shift();
            }
        }

        function detectChanges(oldState, newState) {
            const changes = [];
            
            // Check savings accounts
            if (JSON.stringify(oldState.savingsAccounts) !== JSON.stringify(newState.savingsAccounts)) {
                changes.push('Savings accounts modified');
            }
            
            // Check mortgages
            const mortgageFields = [
                'residentialBalance', 'residentialRate', 'btl1Balance', 'btl1Rate', 'btl2Balance', 'btl2Rate'
            ];
            
            mortgageFields.forEach(field => {
                if (oldState[field] !== newState[field]) {
                    changes.push(`${field} changed from ${oldState[field]} to ${newState[field]}`);
                }
            });
            
            return changes;
        }

        window.openHistoryModal = function() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            
            if (changeHistory.length === 0) {
                content.innerHTML = '<p style="color: var(--color-text-secondary);">No history available yet. Changes will appear here as you modify your data.</p>';
            } else {
                content.innerHTML = changeHistory.slice().reverse().map(item => {
                    const date = new Date(item.timestamp);
                    const timeStr = date.toLocaleString('en-GB', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="history-item">
                            <div class="history-timestamp">${timeStr}</div>
                            <div class="history-change"><strong>${item.action}</strong></div>
                            <div class="history-change">${item.details}</div>
                            ${item.note ? `<div class="history-note">Note: ${item.note}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            modal.classList.add('active');
        };

        window.closeHistoryModal = function() {
            document.getElementById('historyModal').classList.remove('active');
        };

        window.openScenarioModal = function() {
            const modal = document.getElementById('scenarioModal');
            
            // Set current values
            let totalSavings = 0;
            window.savingsAccounts.forEach(acc => totalSavings += acc.balance);
            
            const residentialBalance = parseFloat(document.getElementById('residentialBalance').value) || 0;
            const btl1Balance = parseFloat(document.getElementById('btl1Balance').value) || 0;
            const btl2Balance = parseFloat(document.getElementById('btl2Balance').value) || 0;
            const totalDebt = residentialBalance + btl1Balance + btl2Balance;
            const netWorth = totalSavings - totalDebt;
            
            document.getElementById('currentSavings').textContent = currentCurrency + formatCurrency(totalSavings);
            document.getElementById('currentDebt').textContent = currentCurrency + formatCurrency(totalDebt);
            document.getElementById('currentNetWorth').textContent = currentCurrency + formatCurrency(netWorth);
            
            // Reset scenario inputs
            document.getElementById('scenarioSavingsChange').value = 0;
            document.getElementById('scenarioDebtChange').value = 0;
            document.getElementById('scenarioRateChange').value = 0;
            document.getElementById('scenarioResults').style.display = 'none';
            
            modal.classList.add('active');
        };

        window.closeScenarioModal = function() {
            document.getElementById('scenarioModal').classList.remove('active');
        };

        window.calculateScenario = function() {
            // Get current values
            let totalSavings = 0;
            let totalInterest = 0;
            window.savingsAccounts.forEach(acc => {
                totalSavings += acc.balance;
                totalInterest += acc.balance * (acc.rate / 100 / 12);
            });
            
            const residentialBalance = parseFloat(document.getElementById('residentialBalance').value) || 0;
            const btl1Balance = parseFloat(document.getElementById('btl1Balance').value) || 0;
            const btl2Balance = parseFloat(document.getElementById('btl2Balance').value) || 0;
            const totalDebt = residentialBalance + btl1Balance + btl2Balance;
            
            // Get scenario changes
            const savingsChange = parseFloat(document.getElementById('scenarioSavingsChange').value) || 0;
            const debtChange = parseFloat(document.getElementById('scenarioDebtChange').value) || 0;
            const rateChange = parseFloat(document.getElementById('scenarioRateChange').value) || 0;
            
            // Calculate new values
            const newSavings = totalSavings * (1 + savingsChange / 100);
            const newDebt = totalDebt * (1 + debtChange / 100);
            const newNetWorth = newSavings - newDebt;
            const currentNetWorth = totalSavings - totalDebt;
            const netWorthChange = newNetWorth - currentNetWorth;
            
            // Calculate new monthly interest with rate change
            let newMonthlyInterest = 0;
            window.savingsAccounts.forEach(acc => {
                const newRate = acc.rate + rateChange;
                newMonthlyInterest += (acc.balance * (1 + savingsChange / 100)) * (newRate / 100 / 12);
            });
            
            // Display results
            document.getElementById('scenarioNewSavings').textContent = currentCurrency + formatCurrency(newSavings);
            document.getElementById('scenarioNewDebt').textContent = currentCurrency + formatCurrency(newDebt);
            document.getElementById('scenarioNewNetWorth').textContent = currentCurrency + formatCurrency(newNetWorth);
            document.getElementById('scenarioNetWorthChange').textContent = currentCurrency + formatCurrency(netWorthChange);
            document.getElementById('scenarioNetWorthChange').style.color = netWorthChange >= 0 ? 'var(--color-success)' : 'var(--color-error)';
            document.getElementById('scenarioMonthlyInterest').textContent = currentCurrency + formatCurrency(newMonthlyInterest);
            
            document.getElementById('scenarioResults').style.display = 'block';
        };

        function initializeCharts() {
            // Asset Pie Chart
            const pieCtx = document.getElementById('assetPieChart');
            if (pieCtx && !assetPieChart) {
                assetPieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Savings', 'Debt'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['#218055', '#c0152f'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Net Worth Line Chart
            const lineCtx = document.getElementById('netWorthChart');
            if (lineCtx && !netWorthChart) {
                netWorthChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Net Worth',
                            data: [],
                            borderColor: '#208080',
                            backgroundColor: 'rgba(32, 128, 128, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return currentCurrency + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateCharts(totalSavings, totalDebt, netWorth) {
            // Update pie chart
            if (assetPieChart) {
                assetPieChart.data.datasets[0].data = [totalSavings, totalDebt];
                assetPieChart.update();
            }

            // Update line chart
            if (netWorthChart && historicalData.length > 0) {
                const range = parseInt(document.getElementById('chartRange')?.value || 12);
                const filteredData = historicalData.slice(-range);
                
                netWorthChart.data.labels = filteredData.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                });
                netWorthChart.data.datasets[0].data = filteredData.map(d => d.netWorth);
                netWorthChart.update();
            }
        }

        window.updateChartRange = function() {
            if (historicalData.length > 0) {
                const range = parseInt(document.getElementById('chartRange').value);
                const filteredData = historicalData.slice(-range);
                
                if (netWorthChart) {
                    netWorthChart.data.labels = filteredData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    });
                    netWorthChart.data.datasets[0].data = filteredData.map(d => d.netWorth);
                    netWorthChart.update();
                }
            }
        };

        function calculateDebtFreeTime(totalSavings, totalDebt, monthlyInterest, monthlyPayments) {
            const netMonthlySavings = monthlyInterest - monthlyPayments;
            
            if (netMonthlySavings <= 0) {
                document.getElementById('debtFreeYears').textContent = '‚àû';
                document.getElementById('debtFreeDetail').textContent = 'Monthly payments exceed savings interest. Consider increasing savings or reducing debt.';
                return;
            }

            const monthsToDebtFree = totalDebt / netMonthlySavings;
            const yearsToDebtFree = monthsToDebtFree / 12;

            if (yearsToDebtFree < 1) {
                document.getElementById('debtFreeYears').textContent = Math.ceil(monthsToDebtFree) + ' months';
            } else {
                document.getElementById('debtFreeYears').textContent = yearsToDebtFree.toFixed(1) + ' years';
            }
            
            const targetDate = new Date();
            targetDate.setMonth(targetDate.getMonth() + monthsToDebtFree);
            document.getElementById('debtFreeDetail').textContent = `Projected debt-free by ${targetDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })}`;
        }

        function saveWeeklySnapshot(totalSavings, totalDebt, netWorth) {
            const today = new Date();
            const lastSnapshot = historicalData.length > 0 ? new Date(historicalData[historicalData.length - 1].date) : null;
            
            // Only save if it's been at least 7 days since last snapshot
            if (!lastSnapshot || (today - lastSnapshot) >= 7 * 24 * 60 * 60 * 1000) {
                historicalData.push({
                    date: today.toISOString(),
                    totalSavings,
                    totalDebt,
                    netWorth
                });
                
                // Keep only last 52 weeks
                if (historicalData.length > 52) {
                    historicalData = historicalData.slice(-52);
                }
            }
        }

        function updateReminders() {
            const container = document.getElementById('remindersList');
            const today = new Date();
            const reminders = [];

            // Check mortgage maturity dates
            const btl1Maturity = new Date(document.getElementById('btl1Maturity').value);
            const btl2Maturity = new Date(document.getElementById('btl2Maturity').value);
            const residentialMaturity = new Date(document.getElementById('residentialMaturity').value);

            const checkReminder = (date, name) => {
                const daysUntil = Math.floor((date - today) / (1000 * 60 * 60 * 24));
                if (daysUntil > 0 && daysUntil <= 180) { // 6 months warning
                    reminders.push({
                        days: daysUntil,
                        name: name,
                        date: date
                    });
                }
            };

            checkReminder(btl1Maturity, 'Buy-to-Let 1');
            checkReminder(btl2Maturity, 'Buy-to-Let 2');
            checkReminder(residentialMaturity, 'Residential Mortgage');

            if (reminders.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 14px;">No upcoming mortgage renewals in the next 6 months.</p>';
            } else {
                container.innerHTML = reminders.map(r => `
                    <div style="padding: 12px; background: var(--color-bg); border-left: 4px solid var(--color-warning); border-radius: 6px; margin-bottom: 10px;">
                        <strong>${r.name}</strong> renewal in <strong>${r.days} days</strong>
                        <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 4px;">
                            Due: ${r.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
                        </div>
                    </div>
                `).join('');
            }
        }

        window.exportToCSV = function() {
            let csv = 'Financial Dashboard Export\n';
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // Savings Accounts
            csv += 'Savings Accounts\n';
            csv += 'Account Name,Institution,Balance,Interest Rate,Notes\n';
            window.savingsAccounts.forEach(acc => {
                csv += `"${acc.name}","${acc.institution}",${acc.balance},${acc.rate}%,"${acc.notes}"\n`;
            });
            
            csv += '\nMortgages\n';
            csv += 'Type,Lender,Original Amount,Current Balance,Interest Rate,Maturity Date\n';
            csv += `Residential,${document.getElementById('residentialLender').value},${document.getElementById('residentialOriginal').value},${document.getElementById('residentialBalance').value},${document.getElementById('residentialRate').value}%,${document.getElementById('residentialMaturity').value}\n`;
            csv += `Buy-to-Let 1,${document.getElementById('btl1Lender').value},${document.getElementById('btl1Original').value},${document.getElementById('btl1Balance').value},${document.getElementById('btl1Rate').value}%,${document.getElementById('btl1Maturity').value}\n`;
            csv += `Buy-to-Let 2,${document.getElementById('btl2Lender').value},${document.getElementById('btl2Original').value},${document.getElementById('btl2Balance').value},${document.getElementById('btl2Rate').value}%,${document.getElementById('btl2Maturity').value}\n`;
            
            csv += '\nSummary\n';
            csv += `Total Savings,${document.getElementById('totalSavings').textContent}\n`;
            csv += `Total Debt,${document.getElementById('totalDebt').textContent}\n`;
            csv += `Net Worth,${document.getElementById('netWorthValue').textContent}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial-dashboard-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        window.exportToPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = 20;
            
            // Title
            doc.setFontSize(20);
            doc.text('Financial Dashboard', 20, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, y);
            y += 15;
            
            // Summary
            doc.setFontSize(16);
            doc.text('Summary', 20, y);
            y += 10;
            
            doc.setFontSize(12);
            doc.text(`Total Savings: ${document.getElementById('totalSavings').textContent}`, 20, y);
            y += 8;
            doc.text(`Total Debt: ${document.getElementById('totalDebt').textContent}`, 20, y);
            y += 8;
            doc.text(`Net Worth: ${document.getElementById('netWorthValue').textContent}`, 20, y);
            y += 15;
            
            // Savings Accounts
            doc.setFontSize(16);
            doc.text('Savings Accounts', 20, y);
            y += 10;
            
            doc.setFontSize(10);
            window.savingsAccounts.forEach(acc => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${acc.name} (${acc.institution})`, 20, y);
                y += 6;
                doc.text(`  Balance: ${currentCurrency}${formatCurrency(acc.balance)} | Rate: ${acc.rate}%`, 20, y);
                y += 8;
            });
            
            y += 10;
            
            // Mortgages
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(16);
            doc.text('Mortgages', 20, y);
            y += 10;
            
            doc.setFontSize(10);
            const mortgages = [
                { name: 'Residential', lender: document.getElementById('residentialLender').value, balance: document.getElementById('residentialBalance').value, rate: document.getElementById('residentialRate').value },
                { name: 'Buy-to-Let 1', lender: document.getElementById('btl1Lender').value, balance: document.getElementById('btl1Balance').value, rate: document.getElementById('btl1Rate').value },
                { name: 'Buy-to-Let 2', lender: document.getElementById('btl2Lender').value, balance: document.getElementById('btl2Balance').value, rate: document.getElementById('btl2Rate').value }
            ];
            
            mortgages.forEach(mtg => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${mtg.name} (${mtg.lender})`, 20, y);
                y += 6;
                doc.text(`  Balance: ${currentCurrency}${formatCurrency(parseFloat(mtg.balance))} | Rate: ${mtg.rate}%`, 20, y);
                y += 8;
            });
            
            doc.save(`financial-dashboard-${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.toggleAuthMode = function() {
            isSignUp = !isSignUp;
            document.getElementById('authToggleText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('authToggleLink').textContent = isSignUp ? 'Sign in' : 'Sign up';
        };

        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                await signInWithPopup(auth, provider);
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') {
                    showError('Sign-in cancelled');
                } else if (error.code === 'auth/popup-blocked') {
                    showError('Popup blocked. Please allow popups for this site.');
                } else {
                    showError(error.message);
                }
                console.error('Google sign-in error:', error);
            }
        };

        window.emailSignIn = async function() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                showError(error.message);
            }
        };

        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        function setSyncStatus(syncing) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            if (syncing) {
                indicator.classList.add('syncing');
                text.textContent = 'Syncing...';
            } else {
                indicator.classList.remove('syncing');
                text.textContent = 'Synced';
            }
        }

        async function saveToFirestore(data) {
            if (!currentUser) return;
            
            setSyncStatus(true);
            try {
                await setDoc(doc(db, 'users', currentUser.uid), {
                    data: data,
                    updatedAt: new Date().toISOString()
                });
                setSyncStatus(false);
            } catch (error) {
                // Silently fail and continue using localStorage
                console.warn('Firestore save failed, using localStorage only:', error.code);
                setSyncStatus(false);
            }
        }

        async function loadFromFirestore() {
            if (!currentUser) return null;
            
            try {
                const docRef = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return docSnap.data().data;
                } else {
                    const localData = loadFromLocalStorage();
                    if (localData) {
                        await saveToFirestore(localData);
                        return localData;
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
                return loadFromLocalStorage();
            }
            return null;
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('financialDashboard');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
            }
            return null;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('userName').textContent = displayName;
                document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
                
                // Wait a bit for auth token to fully propagate
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const data = await loadFromFirestore();
                if (data) {
                    loadData(data);
                }
                renderSavingsAccounts();
                recalculate();
                attachSaveListeners();
                
                // Initialize charts
                setTimeout(() => {
                    initializeCharts();
                }, 500);
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 300);
            } else {
                currentUser = null;
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            }
        });

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        };

        window.addSavingsAccount = function() {
            pushToUndoStack();
            
            window.savingsAccounts.push({
                name: 'New Account',
                institution: 'Bank Name',
                balance: 0,
                rate: 0,
                notes: ''
            });
            
            addToHistory('Account added', 'New savings account created');
            
            renderSavingsAccounts();
            recalculate();
        };

        window.deleteSavingsAccount = function(index) {
            if (confirm('Delete this account?')) {
                pushToUndoStack();
                
                const accountName = window.savingsAccounts[index].name;
                window.savingsAccounts.splice(index, 1);
                
                addToHistory('Account deleted', `Removed "${accountName}"`);
                
                renderSavingsAccounts();
                recalculate();
            }
        };

        window.renderSavingsAccounts = function() {
            const container = document.getElementById('savingsAccountsList');
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th style="background: var(--color-bg); color: var(--color-text); padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Account Name</th>
                            <th style="background: var(--color-bg); color: var(--color-text); padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Institution</th>
                            <th style="background: var(--color-bg); color: var(--color-text); padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Balance</th>
                            <th style="background: var(--color-bg); color: var(--color-text); padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Annual Rate (%)</th>
                            <th style="background: var(--color-bg); color: var(--color-text); padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Notes</th>
                            <th style="background: var(--color-bg); color: var(--color-text); padding: 12px; text-align: left; font-weight: 600; font-size: 13px;"></th>
                        </tr>
                    </thead>
                    <tbody id="savingsAccountsTableBody"></tbody>
                </table>
            `;
            
            const tbody = document.getElementById('savingsAccountsTableBody');
            
            window.savingsAccounts.forEach((account, index) => {
                const monthlyInterest = calculateSavingsInterest(account.balance, account.rate);
                const annualInterest = monthlyInterest * 12;
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--color-border)';
                row.innerHTML = `
                    <td style="padding: 12px; vertical-align: top;">
                        <input type="text" value="${account.name}" 
                            data-index="${index}" data-field="name" class="account-field"
                            style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;">
                        <div style="margin-top: 8px; font-size: 12px; color: var(--color-text-secondary);">
                            Monthly Interest<br>
                            <span class="monthly-interest" style="color: var(--color-primary); font-weight: 600;">${currentCurrency}${formatCurrency(monthlyInterest)}</span>
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <input type="text" value="${account.institution}" 
                            data-index="${index}" data-field="institution" class="account-field"
                            style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;">
                        <div style="margin-top: 8px; font-size: 12px; color: var(--color-text-secondary);">
                            Annual Interest<br>
                            <span class="annual-interest" style="color: var(--color-primary); font-weight: 600;">${currentCurrency}${formatCurrency(annualInterest)}</span>
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <input type="number" value="${account.balance}" 
                            data-index="${index}" data-field="balance" class="account-field"
                            style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;">
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <input type="number" step="0.01" value="${account.rate}" 
                            data-index="${index}" data-field="rate" class="account-field"
                            style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;">
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <input type="text" value="${account.notes}" 
                            data-index="${index}" data-field="notes" class="account-field"
                            style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;">
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <button class="btn btn-danger" onclick="window.deleteSavingsAccount(${index})" style="padding: 8px 16px; font-size: 14px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.querySelectorAll('.account-field').forEach(input => {
                input.addEventListener('change', function() {
                    pushToUndoStack();
                    
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const value = field === 'balance' || field === 'rate' 
                        ? parseFloat(this.value) || 0 
                        : this.value;
                    
                    const oldValue = window.savingsAccounts[index][field];
                    window.savingsAccounts[index][field] = value;
                    
                    addToHistory(
                        `Savings account updated`,
                        `${window.savingsAccounts[index].name}: ${field} changed from ${oldValue} to ${value}`
                    );
                    
                    // Re-render to update interest displays
                    if (field === 'balance' || field === 'rate') {
                        const currentFocus = document.activeElement;
                        const focusIndex = currentFocus?.dataset?.index;
                        const focusField = currentFocus?.dataset?.field;
                        
                        renderSavingsAccounts();
                        
                        // Restore focus if it was on an account field
                        if (focusIndex && focusField) {
                            const inputs = document.querySelectorAll('.account-field');
                            inputs.forEach(input => {
                                if (input.dataset.index === focusIndex && input.dataset.field === focusField) {
                                    input.focus();
                                }
                            });
                        }
                    }
                    
                    window.recalculate();
                });
            });
        };

        function calculateSavingsInterest(balance, rate) {
            return balance * (rate / 100 / 12);
        }

        function formatCurrency(value) {
            return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        window.recalculate = function() {
            let totalSavings = 0;
            let monthlyInterest = 0;

            window.savingsAccounts.forEach(account => {
                totalSavings += account.balance;
                monthlyInterest += calculateSavingsInterest(account.balance, account.rate);
            });

            const annualInterest = monthlyInterest * 12;

            document.getElementById('totalSavings').textContent = currentCurrency + formatCurrency(totalSavings);
            document.getElementById('totalSavingsValue').textContent = currentCurrency + formatCurrency(totalSavings);
            document.getElementById('monthlyInterest').textContent = currentCurrency + formatCurrency(monthlyInterest);
            document.getElementById('annualInterest').textContent = currentCurrency + formatCurrency(annualInterest);

            const residentialBalance = parseFloat(document.getElementById('residentialBalance').value) || 0;
            const residentialRate = parseFloat(document.getElementById('residentialRate').value) || 0;
            const residentialTerm = parseFloat(document.getElementById('residentialTerm').value) || 25;
            const monthlyRate = residentialRate / 100 / 12;
            const numPayments = residentialTerm * 12;
            let monthlyPayment = 0;

            if (monthlyRate > 0) {
                monthlyPayment = (residentialBalance * monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            }

            const annualResInt = monthlyPayment * 12 - (residentialBalance / residentialTerm);

            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('annualResInterest').textContent = formatCurrency(annualResInt);

            const btl1Balance = parseFloat(document.getElementById('btl1Balance').value) || 0;
            const btl1Rate = parseFloat(document.getElementById('btl1Rate').value) || 0;
            const btl1MaturityDate = new Date(document.getElementById('btl1Maturity').value);
            const btl1MonthlyPayment = btl1Balance * (btl1Rate / 100 / 12);
            const btl1AnnualInt = btl1MonthlyPayment * 12;
            const yearsUntilMaturity1 = Math.max(0, btl1MaturityDate.getFullYear() - new Date().getFullYear());

            document.getElementById('btl1MonthlyPayment').textContent = formatCurrency(btl1MonthlyPayment);
            document.getElementById('btl1AnnualInterest').textContent = formatCurrency(btl1AnnualInt);
            document.getElementById('btl1Capital').textContent = formatCurrency(btl1Balance);
            document.getElementById('btl1Years').textContent = yearsUntilMaturity1;
            document.getElementById('btl1AnnualPlan').textContent = formatCurrency(yearsUntilMaturity1 > 0 ? btl1Balance / yearsUntilMaturity1 : 0);
            
            // Update BTL1 progress bar
            const btl1Original = parseFloat(document.getElementById('btl1Original').value) || btl1Balance;
            const btl1Progress = btl1Original > 0 ? ((btl1Original - btl1Balance) / btl1Original * 100) : 0;
            document.getElementById('btl1Progress').style.width = btl1Progress + '%';
            document.getElementById('btl1ProgressText').textContent = Math.round(btl1Progress) + '% paid off';

            const btl2Balance = parseFloat(document.getElementById('btl2Balance').value) || 0;
            const btl2Rate = parseFloat(document.getElementById('btl2Rate').value) || 0;
            const btl2MaturityDate = new Date(document.getElementById('btl2Maturity').value);
            const btl2MonthlyPayment = btl2Balance * (btl2Rate / 100 / 12);
            const btl2AnnualInt = btl2MonthlyPayment * 12;
            const yearsUntilMaturity2 = Math.max(0, btl2MaturityDate.getFullYear() - new Date().getFullYear());

            document.getElementById('btl2MonthlyPayment').textContent = formatCurrency(btl2MonthlyPayment);
            document.getElementById('btl2AnnualInterest').textContent = formatCurrency(btl2AnnualInt);
            document.getElementById('btl2Capital').textContent = formatCurrency(btl2Balance);
            document.getElementById('btl2Years').textContent = yearsUntilMaturity2;
            document.getElementById('btl2AnnualPlan').textContent = formatCurrency(yearsUntilMaturity2 > 0 ? btl2Balance / yearsUntilMaturity2 : 0);
            
            // Update BTL2 progress bar
            const btl2Original = parseFloat(document.getElementById('btl2Original').value) || btl2Balance;
            const btl2Progress = btl2Original > 0 ? ((btl2Original - btl2Balance) / btl2Original * 100) : 0;
            document.getElementById('btl2Progress').style.width = btl2Progress + '%';
            document.getElementById('btl2ProgressText').textContent = Math.round(btl2Progress) + '% paid off';

            const totalDebt = residentialBalance + btl1Balance + btl2Balance;
            const totalPayments = monthlyPayment + btl1MonthlyPayment + btl2MonthlyPayment;
            const netWorth = totalSavings - totalDebt;

            document.getElementById('totalDebt').textContent = currentCurrency + formatCurrency(totalDebt);
            document.getElementById('totalPayments').textContent = currentCurrency + formatCurrency(totalPayments);
            document.getElementById('totalMortgagePayment').textContent = currentCurrency + formatCurrency(totalPayments);
            document.getElementById('netLiabilities').textContent = currentCurrency + formatCurrency(totalDebt);
            document.getElementById('netWorthValue').textContent = currentCurrency + formatCurrency(netWorth);

            const netWorthEl = document.getElementById('netWorth');
            if (netWorth >= 0) {
                netWorthEl.classList.remove('negative');
                netWorthEl.classList.add('positive');
            } else {
                netWorthEl.classList.remove('positive');
                netWorthEl.classList.add('negative');
            }

            updateSavingsSummaryTable();
            updateMortgageSummaryTable();

            document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
            
            // Update charts and insights
            updateCharts(totalSavings, totalDebt, netWorth);
            calculateDebtFreeTime(totalSavings, totalDebt, monthlyInterest, totalPayments);
            updateReminders();
            saveWeeklySnapshot(totalSavings, totalDebt, netWorth);
            
            saveData();
        };

        function updateSavingsSummaryTable() {
            const tbody = document.getElementById('savingsSummaryTable');
            tbody.innerHTML = '';

            window.savingsAccounts.forEach(acc => {
                const monthlyInt = calculateSavingsInterest(acc.balance, acc.rate);
                const row = `
                    <tr>
                        <td>${acc.name}</td>
                        <td>¬£${formatCurrency(acc.balance)}</td>
                        <td>${acc.rate}%</td>
                        <td>¬£${formatCurrency(monthlyInt)}</td>
                        <td>${acc.notes}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateMortgageSummaryTable() {
            const tbody = document.getElementById('mortgageSummaryTable');
            tbody.innerHTML = '';

            const residentialBalance = parseFloat(document.getElementById('residentialBalance').value) || 0;
            const residentialRate = parseFloat(document.getElementById('residentialRate').value) || 0;
            const residentialTerm = parseFloat(document.getElementById('residentialTerm').value) || 25;
            const monthlyRate = residentialRate / 100 / 12;
            const numPayments = residentialTerm * 12;
            let monthlyPayment = 0;

            if (monthlyRate > 0) {
                monthlyPayment = (residentialBalance * monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            }

            const btl1Balance = parseFloat(document.getElementById('btl1Balance').value) || 0;
            const btl1Rate = parseFloat(document.getElementById('btl1Rate').value) || 0;
            const btl1MonthlyPayment = btl1Balance * (btl1Rate / 100 / 12);

            const btl2Balance = parseFloat(document.getElementById('btl2Balance').value) || 0;
            const btl2Rate = parseFloat(document.getElementById('btl2Rate').value) || 0;
            const btl2MonthlyPayment = btl2Balance * (btl2Rate / 100 / 12);

            tbody.innerHTML = `
                <tr>
                    <td>Residential (Repayment)</td>
                    <td>¬£${formatCurrency(residentialBalance)}</td>
                    <td>${residentialRate}%</td>
                    <td>¬£${formatCurrency(monthlyPayment)}</td>
                    <td>${document.getElementById('residentialMaturity').value}</td>
                </tr>
                <tr>
                    <td>Buy-to-Let 1 (Interest Only)</td>
                    <td>¬£${formatCurrency(btl1Balance)}</td>
                    <td>${btl1Rate}%</td>
                    <td>¬£${formatCurrency(btl1MonthlyPayment)}</td>
                    <td>${document.getElementById('btl1Maturity').value}</td>
                </tr>
                <tr>
                    <td>Buy-to-Let 2 (Interest Only)</td>
                    <td>¬£${formatCurrency(btl2Balance)}</td>
                    <td>${btl2Rate}%</td>
                    <td>¬£${formatCurrency(btl2MonthlyPayment)}</td>
                    <td>${document.getElementById('btl2Maturity').value}</td>
                </tr>
            `;
        }

        window.resetSavings = function() {
            if (confirm('Reset all savings accounts to defaults?')) {
                window.savingsAccounts = [
                    { name: 'Premium Savings Account', institution: 'Your Bank Name', balance: 45000, rate: 5.15, notes: 'ISA - Tax Free' },
                    { name: 'Standard Savings', institution: 'Your Bank Name', balance: 12500, rate: 3.50, notes: 'Regular Saver' },
                    { name: 'Money Market Fund', institution: 'Your Bank Name', balance: 8750, rate: 4.25, notes: 'Short-term parking' }
                ];
                renderSavingsAccounts();
                recalculate();
            }
        };

        function saveData() {
            // Capture state for undo before saving
            if (!isUndoRedoAction && undoStack.length === 0) {
                pushToUndoStack();
            }
            
            const data = {
                savingsAccounts: window.savingsAccounts,
                currency: currentCurrency,
                historicalData: historicalData,
                changeHistory: changeHistory,
                residentialLender: document.getElementById('residentialLender').value,
                residentialOriginal: document.getElementById('residentialOriginal').value,
                residentialBalance: document.getElementById('residentialBalance').value,
                residentialRate: document.getElementById('residentialRate').value,
                residentialTerm: document.getElementById('residentialTerm').value,
                residentialMaturity: document.getElementById('residentialMaturity').value,
                btl1Lender: document.getElementById('btl1Lender').value,
                btl1Original: document.getElementById('btl1Original').value,
                btl1Balance: document.getElementById('btl1Balance').value,
                btl1Rate: document.getElementById('btl1Rate').value,
                btl1Maturity: document.getElementById('btl1Maturity').value,
                btl2Lender: document.getElementById('btl2Lender').value,
                btl2Original: document.getElementById('btl2Original').value,
                btl2Balance: document.getElementById('btl2Balance').value,
                btl2Rate: document.getElementById('btl2Rate').value,
                btl2Maturity: document.getElementById('btl2Maturity').value
            };
            localStorage.setItem('financialDashboard', JSON.stringify(data));
            updateLastSaved();
            
            if (!isLoadingFromSnapshot) {
                saveToFirestore(data);
            }
        }

        function loadData(data) {
            if (!data) return;
            
            window.savingsAccounts = data.savingsAccounts || window.savingsAccounts;
            historicalData = data.historicalData || [];
            changeHistory = data.changeHistory || [];
            
            if (data.currency) {
                currentCurrency = data.currency;
                document.getElementById('currencySelector').value = currentCurrency;
            }
            
            document.getElementById('residentialLender').value = data.residentialLender || 'Your Bank Name';
            document.getElementById('residentialOriginal').value = data.residentialOriginal || '450000';
            document.getElementById('residentialBalance').value = data.residentialBalance || '250000';
            document.getElementById('residentialRate').value = data.residentialRate || '4.75';
            document.getElementById('residentialTerm').value = data.residentialTerm || '25';
            document.getElementById('residentialMaturity').value = data.residentialMaturity || '2050-12-31';
            document.getElementById('btl1Lender').value = data.btl1Lender || 'Your Bank Name';
            document.getElementById('btl1Original').value = data.btl1Original || '200000';
            document.getElementById('btl1Balance').value = data.btl1Balance || '180000';
            document.getElementById('btl1Rate').value = data.btl1Rate || '5.25';
            document.getElementById('btl1Maturity').value = data.btl1Maturity || '2035-09-30';
            document.getElementById('btl2Lender').value = data.btl2Lender || 'Your Bank Name';
            document.getElementById('btl2Original').value = data.btl2Original || '150000';
            document.getElementById('btl2Balance').value = data.btl2Balance || '150000';
            document.getElementById('btl2Rate').value = data.btl2Rate || '5.10';
            document.getElementById('btl2Maturity').value = data.btl2Maturity || '2038-03-31';
        }

        function attachSaveListeners() {
            const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]');
            inputs.forEach(input => {
                // Skip savings account fields as they have their own listeners
                if (input.classList.contains('account-field')) {
                    return;
                }
                
                input.removeEventListener('change', handleInputChange);
                input.addEventListener('change', handleInputChange);
            });
        }
        
        function handleInputChange(event) {
            pushToUndoStack();
            
            const fieldId = event.target.id;
            const newValue = event.target.value;
            const fieldName = event.target.previousElementSibling?.textContent || fieldId;
            
            addToHistory(`Field updated`, `${fieldName} changed to ${newValue}`);
            
            window.recalculate();
            saveData();
        }
    </script>
</body>
</html>
